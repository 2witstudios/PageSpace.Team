# Integration: Tiptap

This document outlines how pagespace integrates with Tiptap for a powerful and customized rich-text editing experience.

## High-Level Overview

Tiptap is a headless, framework-agnostic rich text editor that serves as the foundation for all text input across the application. Because it is headless, we have built a significant amount of custom UI, extensions, and logic around it to create a feature-rich experience tailored to our needs, most notably our `@mention` and suggestion system.

We use Tiptap in two primary contexts:
1.  **Document Editor (`Editor.tsx`):** A full-featured editor for long-form document pages.
2.  **Chat Input (`TiptapChatInput.tsx`):** A lightweight, specialized editor for sending messages in channels and the AI Assistant.

All content generated by Tiptap is stored as JSON in the database.

## Core Editor Components

### 1. The Document Editor

-   **Location:** [`apps/web/src/components/layout/middle-content/page-views/document/Editor.tsx`](apps/web/src/components/layout/middle-content/page-views/document/Editor.tsx:1)
-   **Description:** This is the primary editor for creating and editing documents. It includes a full toolbar and supports all standard rich-text features.
-   **Key Features:**
    -   **Auto-Saving:** It uses the `useDebounce` hook to automatically save the editor's content to the database via a `PATCH` request to `/api/pages/:pageId` about one second after the user stops typing.
    -   **Extensions:** It loads the Tiptap `StarterKit` along with our two custom extensions, `Mention` and `MentionSuggestion`, which power the mention system.

### 2. The Chat Input

-   **Location:** [`apps/web/src/components/messages/TiptapChatInput.tsx`](apps/web/src/components/messages/TiptapChatInput.tsx:1)
-   **Description:** A streamlined version of the editor specifically for chat contexts.
-   **Key Features:**
    -   **Minimal Extensions:** It uses a modified `StarterKit` that disables block-level elements like headings and lists to keep the input simple.
    -   **Submit on Enter:** It includes custom `handleKeyDown` logic to submit the content when the user presses `Enter` (unless the suggestion popup is open).
    -   **Toolbar (Optional):** Can display a compact version of the toolbar for basic formatting.

## The Mention & Suggestion System

Our `@mention` functionality is a sophisticated, decoupled system that integrates with Tiptap. This allows us to reuse the same suggestion logic for different types of inputs.

Here is the flow of data and control when a user types `@`:

1.  **`MentionSuggestionPlugin.ts` (The Tiptap Plugin):**
    -   **Location:** [`apps/web/src/components/mentions/MentionSuggestionPlugin.ts`](apps/web/src/components/mentions/MentionSuggestionPlugin.ts:1)
    -   **Role:** This is a custom Tiptap `Extension`. Its `state.apply` method constantly watches the editor's content for a `@` followed by a query (e.g., `@John`).
    -   When it detects a match, its `view.update` method is triggered. This method is responsible for telling the global suggestion store to open the popup and positioning it correctly. It also kicks off the search process.

2.  **`mention-system.ts` (The Agnostic Core Logic):**
    -   **Location:** [`apps/web/src/lib/mention-system.ts`](apps/web/src/lib/mention-system.ts:1)
    -   **Role:** This is a plain TypeScript class that contains the editor-agnostic logic for handling mentions.
    -   Its `search` method is called by the plugin. It constructs a request to our backend (`/api/mentions/search`) to get a list of relevant pages, users, etc.
    -   Once it receives the results, it updates a global Zustand store with the suggestion items.

3.  **`useSuggestionStore` (The Global State):**
    -   **Location:** [`apps/web/src/hooks/useSuggestion.ts`](apps/web/src/hooks/useSuggestion.ts:1)
    -   **Role:** A Zustand store that holds the global state for the suggestion popup, including whether it's open, its position, the current search query, and the list of items to display.

4.  **`SuggestionList.tsx` (The UI Component):**
    -   **Location:** [`apps/web/src/components/mentions/SuggestionList.tsx`](apps/web/src/components/mentions/SuggestionList.tsx:1)
    -   **Role:** This is the React component that renders the actual popup. It subscribes to the `useSuggestionStore` to get the list of items. It handles keyboard navigation (up/down/enter) and calls a `command` function when an item is selected.

5.  **`TiptapMentionAdapter.ts` (The "Glue"):**
    -   **Location:** [`apps/web/src/components/mentions/TiptapMentionAdapter.ts`](apps/web/src/components/mentions/TiptapMentionAdapter.ts:1)
    -   **Role:** This class connects the generic `mentionSystem` and `SuggestionList` back to the specific Tiptap editor instance.
    -   When the `MentionSuggestionPlugin` opens the popup, it passes a function to the store that, when called, uses this adapter.
    -   The adapter's `insert` method contains the final Tiptap command (`editor.chain().focus().insertContentAt(...)`) to insert the selected mention into the editor as a custom node.

## Rendering Read-Only Content

-   **Location:** [`apps/web/src/components/rich-text/TiptapRenderer.tsx`](apps/web/src/components/rich-text/TiptapRenderer.tsx:1)
-   **Description:** To display saved Tiptap content in a read-only format, we use this component.
-   **Implementation:** It is essentially a non-editable Tiptap editor instance. This is the simplest and most reliable way to ensure that all custom nodes (like our `@mentions`) are rendered correctly, as it reuses the exact same rendering logic as the editor itself. It parses the stored JSON and displays it.